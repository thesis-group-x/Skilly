
import 'package:flutter/material.dart';
import 'package:http/http.dart' as http;
import 'dart:convert';
import 'user-profile.dart';
import 'package:image_picker/image_picker.dart';
import 'dart:io';
import 'package:firebase_auth/firebase_auth.dart';
import './feed/pages/home_page.dart';
import 'package:dio/dio.dart';

void main() {
  runApp(MaterialApp(
    home: Complete(),
  ));
}

class Complete extends StatefulWidget {
  const Complete({Key? key}) : super(key: key);

  @override
  _CompleteState createState() => _CompleteState();
}

class _CompleteState extends State<Complete> {
  String _selectedGender = 'Gender';
  String _selectedLocation = 'Location';
  String? _imageUrl;

  final TextEditingController nameController = TextEditingController();
  final TextEditingController ageController = TextEditingController();
  final TextEditingController detailsController = TextEditingController();

  File? _selectedImage;

  Future<void> sendUpdateRequest() async {
    final user = FirebaseAuth.instance.currentUser;
    print(FirebaseAuth.instance.currentUser);

    if (user != null) {
      final userId = user.email;
      final String name = nameController.text;
      final int age = int.tryParse(ageController.text) ?? 0;
      final String gender = _selectedGender;
      final String location = _selectedLocation;
      final String bio = detailsController.text;

      Future<void> sendUpdateRequest() async {
        // Check if all fields are filled
        if (name.isEmpty ||
            age <= 0 ||
            gender == 'Gender' ||
            location == 'Location' ||
            bio.isEmpty) {
          showDialog(
            context: context,
            builder: (_) => AlertDialog(
              title: const Text('Missing Information'),
              content: const Text('Please fill in all the fields.'),
              actions: [
                TextButton(
                  onPressed: () {
                    Navigator.of(context).pop();
                  },
                  child: const Text('OK'),
                ),
              ],
            ),
          );
          return;
          //  Exit the function if any information is missing
        }
      }

      // Prepare the request body
      final Map<String, dynamic> requestBody = {
        'name': name,
        'age': age,
        'gender': gender,
        'address': location,
        'details': bio,
      };

      if (_imageUrl != null) {
        requestBody['imageUrl'] = _imageUrl;
        // Add the image URL to the request body
      }

      final response = await http.put(
        Uri.parse('http://10.0.2.2:3001/up/updateuser/$userId'),
        body: json.encode(requestBody),
        headers: {'Content-Type': 'application/json'},
      );

      if (response.statusCode == 200) {
        // Update successful
        Navigator.push(
          context,
          MaterialPageRoute(builder: (context) => HomePage()),
        );
      } else {
        // Update failed
        showDialog(
          context: context,
          builder: (_) => AlertDialog(
            title: const Text('Update Failed'),
            content: const Text('Unable to update user profile.'),
            actions: [
              TextButton(
                onPressed: () {
                  Navigator.of(context).pop();
                },
                child: const Text('OK'),
              ),
            ],
          ),
        );
      }
    }
  }

  Future<void> uploadImageToCloudinary(File imageFile) async {
    final url =
        Uri.parse('https://api.cloudinary.com/v1_1/dkplhzt8t/image/upload');
    final request = http.MultipartRequest('POST', url);
    request.headers['X-Upload-Preset'] = 'kusldcryyyyy';
    request.files
        .add(await http.MultipartFile.fromPath('file', imageFile.path));

    final response = await request.send();

    if (response.statusCode == 200) {
      final responseData = await response.stream.transform(utf8.decoder).join();
      final data = json.decode(responseData);
      setState(() {
        _imageUrl = data['secure_url']; // Update the _imageUrl variable
      });
    } else {
      // Image upload failed
      showDialog(
        context: context,
        builder: (_) => AlertDialog(
          title: const Text('Image Upload Failed'),
          content: const Text('Unable to upload the selected image.'),
          actions: [
            TextButton(
              onPressed: () {
                Navigator.of(context).pop();
              },
              child: const Text('OK'),
            ),
          ],
        ),
      );
    }
  }

  Future<void> pickImage() async {
    final imagePicker = ImagePicker();
    final pickedImage =
        await imagePicker.pickImage(source: ImageSource.gallery);

    if (pickedImage != null) {
      setState(() {
        _selectedImage = File(pickedImage.path);
      });

      await uploadImageToCloudinary(
          _selectedImage!); // Upload the selected image
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Color(0xFFFAFAFA), // Set the background color
      appBar: AppBar(
        backgroundColor: Colors.transparent,
        elevation: 0,
        title: const Text(
          'Complete your profile',
          style: TextStyle(
            fontSize: 24,
            color: Colors.black,
          ),
        ),
      ),
      body: SingleChildScrollView(
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Padding(
              padding: const EdgeInsets.symmetric(horizontal: 30, vertical: 16),
              child: GestureDetector(
                onTap: pickImage,
                child: CircleAvatar(
                  backgroundColor: Colors.black,
                  radius: 50,
                  backgroundImage: _selectedImage != null
                      ? FileImage(_selectedImage!)
                      : null,
                  child: _selectedImage == null
                      ? Icon(Icons.person, color: Colors.white)
                      : null,
                ),
              ),
            ),
            Padding(
              padding: const EdgeInsets.symmetric(horizontal: 30),
              child: TextField(
                controller: nameController,
                decoration: InputDecoration(
                  filled: true,
                  fillColor: Colors.transparent, // Set the text field color
                  prefixIcon: Icon(
                    Icons.person,
                    color: Colors.black,
                  ),
                  hintText: 'username',
                  hintStyle: TextStyle(color: Colors.black),
                ),
              ),
            ),
            SizedBox(height: 16),
            Padding(
              padding: const EdgeInsets.symmetric(horizontal: 30),
              child: TextField(
                controller: ageController,
                decoration: InputDecoration(
                  filled: true,
                  fillColor: Colors.transparent, // Set the text field color
                  prefixIcon: Icon(
                    Icons.calendar_month,
                    color: Colors.black,
                  ),
                  hintText: ' age',
                  hintStyle: TextStyle(color: Colors.black),
                ),
              ),
            ),
            SizedBox(height: 16),
            Padding(
              padding: const EdgeInsets.symmetric(horizontal: 30),
              child: DropdownButtonFormField<String>(
                decoration: InputDecoration(
                  filled: true,
                  fillColor: Colors.transparent, // Set the dropdown color
                  prefixIcon: Icon(
                    Icons.group,
                    color: Colors.black,
                  ),
                  hintText: 'Select your gender',
                  hintStyle: TextStyle(color: Colors.grey),
                ),
                value: _selectedGender,
                items: <String>['Gender', 'Male', 'Female', 'Other']
                    .map<DropdownMenuItem<String>>(
                      (String value) => DropdownMenuItem<String>(
                        value: value,
                        child: Text(value),
                      ),
                    )
                    .toList(),
                onChanged: (String? newValue) {
                  setState(() {
                    _selectedGender = newValue ?? '';
                  });
                },
              ),
            ),
            SizedBox(height: 16),
            Padding(
              padding: const EdgeInsets.symmetric(horizontal: 30),
              child: DropdownButtonFormField<String>(
                decoration: InputDecoration(
                  filled: true,
                  fillColor: Colors.transparent, // Set the dropdown color
                  prefixIcon: Icon(
                    Icons.location_on,
                    color: Colors.black,
                  ),
                  hintText: 'Select your location',
                  hintStyle: TextStyle(color: Colors.grey),
                ),
                value: _selectedLocation,
                items: <String>[
                  'Location', // Add a default value if needed
                  'ðŸ‡¦ðŸ‡« Afghanistan',
                  'ðŸ‡¦ðŸ‡± Albania',
                  'ðŸ‡©ðŸ‡¿ Algeria',
                  'ðŸ‡¦ðŸ‡© Andorra',
                  'ðŸ‡¦ðŸ‡´ Angola',
                  'ðŸ‡¦ðŸ‡¬ Antigua and Barbuda',
                  'ðŸ‡¦ðŸ‡· Argentina',
                  'ðŸ‡¦ðŸ‡² Armenia',
                  'ðŸ‡¦ðŸ‡º Australia',
                  'ðŸ‡¦ðŸ‡¹ Austria',
                  'ðŸ‡¦ðŸ‡¿ Azerbaijan',
                  'ðŸ‡§ðŸ‡¸ Bahamas',
                  'ðŸ‡§ðŸ‡­ Bahrain',
                  'ðŸ‡§ðŸ‡© Bangladesh',
                  'ðŸ‡§ðŸ‡§ Barbados',
                  'ðŸ‡§ðŸ‡¾ Belarus',
                  'ðŸ‡§ðŸ‡ª Belgium',
                  'ðŸ‡§ðŸ‡¿ Belize',
                  'ðŸ‡§ðŸ‡¯ Benin',
                  'ðŸ‡§ðŸ‡¹ Bhutan',
                  'ðŸ‡§ðŸ‡´ Bolivia',
                  'ðŸ‡§ðŸ‡¦ Bosnia and Herzegovina',
                  'ðŸ‡§ðŸ‡¼ Botswana',
                  'ðŸ‡§ðŸ‡· Brazil',
                  'ðŸ‡§ðŸ‡³ Brunei',
                  'ðŸ‡§ðŸ‡¬ Bulgaria',
                  'ðŸ‡§ðŸ‡« Burkina Faso',
                  'ðŸ‡§ðŸ‡® Burundi',
                  'ðŸ‡¨ðŸ‡» Cape Verde',
                  'ðŸ‡°ðŸ‡­ Cambodia',
                  'ðŸ‡¨ðŸ‡² Cameroon',
                  'ðŸ‡¨ðŸ‡¦ Canada',
                  'ðŸ‡¨ðŸ‡« Central African Republic',
                  'ðŸ‡¹ðŸ‡© Chad',
                  'ðŸ‡¨ðŸ‡± Chile',
                  'ðŸ‡¨ðŸ‡³ China',
                  'ðŸ‡¨ðŸ‡´ Colombia',
                  'ðŸ‡°ðŸ‡² Comoros',
                  'ðŸ‡¨ðŸ‡© Congo ',
                  'ðŸ‡¨ðŸ‡· Costa Rica',
                  'ðŸ‡­ðŸ‡· Croatia',
                  'ðŸ‡¨ðŸ‡º Cuba',
                  'ðŸ‡¨ðŸ‡¾ Cyprus',
                  'ðŸ‡¨ðŸ‡¿ Czech Republic',
                  'ðŸ‡©ðŸ‡° Denmark',
                  'ðŸ‡©ðŸ‡¯ Djibouti',
                  'ðŸ‡©ðŸ‡² Dominica',
                  'ðŸ‡©ðŸ‡´ Dominican Republic',
                  'ðŸ‡ªðŸ‡¨ Ecuador',
                  'ðŸ‡ªðŸ‡¬ Egypt',
                  'ðŸ‡¸ðŸ‡» El Salvador',
                  'ðŸ‡¬ðŸ‡¶ Equatorial Guinea',
                  'ðŸ‡ªðŸ‡· Eritrea',
                  'ðŸ‡ªðŸ‡ª Estonia',
                  'ðŸ‡ªðŸ‡¹ Ethiopia',
                  'ðŸ‡«ðŸ‡¯ Fiji',
                  'ðŸ‡«ðŸ‡® Finland',
                  'ðŸ‡«ðŸ‡· France',
                  'ðŸ‡¬ðŸ‡¦ Gabon',
                  'ðŸ‡¬ðŸ‡² Gambia',
                  'ðŸ‡¬ðŸ‡ª Georgia',
                  'ðŸ‡©ðŸ‡ª Germany',
                  'ðŸ‡¬ðŸ‡­ Ghana',
                  'ðŸ‡¬ðŸ‡· Greece',
                  'ðŸ‡¬ðŸ‡© Grenada',
                  'ðŸ‡¬ðŸ‡¹ Guatemala',
                  'ðŸ‡¬ðŸ‡³ Guinea',
                  'ðŸ‡¬ðŸ‡¼ Guinea-Bissau',
                  'ðŸ‡¬ðŸ‡¾ Guyana',
                  'ðŸ‡­ðŸ‡¹ Haiti',
                  'ðŸ‡­ðŸ‡³ Honduras',
                  'ðŸ‡­ðŸ‡º Hungary',
                  'ðŸ‡®ðŸ‡¸ Iceland',
                  'ðŸ‡®ðŸ‡³ India',
                  'ðŸ‡®ðŸ‡© Indonesia',
                  'ðŸ‡®ðŸ‡· Iran',
                  'ðŸ‡®ðŸ‡¶ Iraq',
                  'ðŸ‡®ðŸ‡ª Ireland',
                  'ðŸ‡®ðŸ‡± Israel',
                  'ðŸ‡®ðŸ‡¹ Italy',
                  'ðŸ‡¯ðŸ‡² Jamaica',
                  'ðŸ‡¯ðŸ‡µ Japan',
                  'ðŸ‡¯ðŸ‡´ Jordan',
                  'ðŸ‡°ðŸ‡¿ Kazakhstan',
                  'ðŸ‡°ðŸ‡ª Kenya',
                  'ðŸ‡°ðŸ‡® Kiribati',
                  'ðŸ‡°ðŸ‡µ North Korea',
                  'ðŸ‡°ðŸ‡· South Korea',
                  'ðŸ‡°ðŸ‡¼ Kuwait',
                  'ðŸ‡°ðŸ‡¬ Kyrgyzstan',
                  'ðŸ‡±ðŸ‡¦ Laos',
                  'ðŸ‡±ðŸ‡» Latvia',
                  'ðŸ‡±ðŸ‡§ Lebanon',
                  'ðŸ‡±ðŸ‡¸ Lesotho',
                  'ðŸ‡±ðŸ‡· Liberia',
                  'ðŸ‡±ðŸ‡¾ Libya',
                  'ðŸ‡±ðŸ‡® Liechtenstein',
                  'ðŸ‡±ðŸ‡¹ Lithuania',
                  'ðŸ‡±ðŸ‡º Luxembourg',
                  'ðŸ‡²ðŸ‡° North Macedonia',
                  'ðŸ‡²ðŸ‡¬ Madagascar',
                  'ðŸ‡²ðŸ‡¼ Malawi',
                  'ðŸ‡²ðŸ‡¾ Malaysia',
                  'ðŸ‡²ðŸ‡» Maldives',
                  'ðŸ‡²ðŸ‡± Mali',
                  'ðŸ‡²ðŸ‡¹ Malta',
                  'ðŸ‡²ðŸ‡­ Marshall Islands',
                  'ðŸ‡²ðŸ‡· Mauritania',
                  'ðŸ‡²ðŸ‡º Mauritius',
                  'ðŸ‡²ðŸ‡½ Mexico',
                  'ðŸ‡«ðŸ‡² Micronesia',
                  'ðŸ‡²ðŸ‡© Moldova',
                  'ðŸ‡²ðŸ‡¨ Monaco',
                  'ðŸ‡²ðŸ‡³ Mongolia',
                  'ðŸ‡²ðŸ‡ª Montenegro',
                  'ðŸ‡²ðŸ‡¦ Morocco',
                  'ðŸ‡²ðŸ‡¿ Mozambique',
                  'ðŸ‡²ðŸ‡² Myanmar',
                  'ðŸ‡³ðŸ‡¦ Namibia',
                  'ðŸ‡³ðŸ‡· Nauru',
                  'ðŸ‡³ðŸ‡µ Nepal',
                  'ðŸ‡³ðŸ‡± Netherlands',
                  'ðŸ‡³ðŸ‡¿ New Zealand',
                  'ðŸ‡³ðŸ‡® Nicaragua',
                  'ðŸ‡³ðŸ‡ª Niger',
                  'ðŸ‡³ðŸ‡¬ Nigeria',
                  'ðŸ‡³ðŸ‡´ Norway',
                  'ðŸ‡´ðŸ‡² Oman',
                  'ðŸ‡µðŸ‡° Pakistan',
                  'ðŸ‡µðŸ‡¼ Palau',
                  'ðŸ‡µðŸ‡¸ Palestine',
                  'ðŸ‡µðŸ‡¦ Panama',
                  'ðŸ‡µðŸ‡¬ Papua New Guinea',
                  'ðŸ‡µðŸ‡¾ Paraguay',
                  'ðŸ‡µðŸ‡ª Peru',
                  'ðŸ‡µðŸ‡­ Philippines',
                  'ðŸ‡µðŸ‡± Poland',
                  'ðŸ‡µðŸ‡¹ Portugal',
                  'ðŸ‡¶ðŸ‡¦ Qatar',
                  'ðŸ‡·ðŸ‡´ Romania',
                  'ðŸ‡·ðŸ‡º Russia',
                  'ðŸ‡·ðŸ‡¼ Rwanda',
                  'ðŸ‡°ðŸ‡³ Saint Kitts and Nevis',
                  'ðŸ‡±ðŸ‡¨ Saint Lucia',
                  'ðŸ‡»ðŸ‡¨ Saint Vincent and the Grenadines',
                  'ðŸ‡¼ðŸ‡¸ Samoa',
                  'ðŸ‡¸ðŸ‡² San Marino',
                  'ðŸ‡¸ðŸ‡¹ Sao Tome and Principe',
                  'ðŸ‡¸ðŸ‡¦ Saudi Arabia',
                  'ðŸ‡¸ðŸ‡³ Senegal',
                  'ðŸ‡·ðŸ‡¸ Serbia',
                  'ðŸ‡¸ðŸ‡¨ Seychelles',
                  'ðŸ‡¸ðŸ‡± Sierra Leone',
                  'ðŸ‡¸ðŸ‡¬ Singapore',
                  'ðŸ‡¸ðŸ‡° Slovakia',
                  'ðŸ‡¸ðŸ‡® Slovenia',
                  'ðŸ‡¸ðŸ‡§ Solomon Islands',
                  'ðŸ‡¸ðŸ‡´ Somalia',
                  'ðŸ‡¿ðŸ‡¦ South Africa',
                  'ðŸ‡¸ðŸ‡¸ South Sudan',
                  'ðŸ‡ªðŸ‡¸ Spain',
                  'ðŸ‡±ðŸ‡° Sri Lanka',
                  'ðŸ‡¸ðŸ‡© Sudan',
                  'ðŸ‡¸ðŸ‡· Suriname',
                  'ðŸ‡¸ðŸ‡ª Sweden',
                  'ðŸ‡¨ðŸ‡­ Switzerland',
                  'ðŸ‡¸ðŸ‡¾ Syria',
                  'ðŸ‡¹ðŸ‡¼ Taiwan',
                  'ðŸ‡¹ðŸ‡¯ Tajikistan',
                  'ðŸ‡¹ðŸ‡¿ Tanzania',
                  'ðŸ‡¹ðŸ‡­ Thailand',
                  'ðŸ‡¹ðŸ‡± Timor-Leste',
                  'ðŸ‡¹ðŸ‡¬ Togo',
                  'ðŸ‡¹ðŸ‡´ Tonga',
                  'ðŸ‡¹ðŸ‡¹ Trinidad and Tobago',
                  'ðŸ‡¹ðŸ‡³ Tunisia',
                  'ðŸ‡¹ðŸ‡· Turkey',
                  'ðŸ‡¹ðŸ‡² Turkmenistan',
                  'ðŸ‡¹ðŸ‡» Tuvalu',
                  'ðŸ‡ºðŸ‡¬ Uganda',
                  'ðŸ‡ºðŸ‡¦ Ukraine',
                  'ðŸ‡¦ðŸ‡ª United Arab Emirates',
                  'ðŸ‡¬ðŸ‡§ United Kingdom',
                  'ðŸ‡ºðŸ‡¸ United States',
                  'ðŸ‡ºðŸ‡¾ Uruguay',
                  'ðŸ‡ºðŸ‡¿ Uzbekistan',
                  'ðŸ‡»ðŸ‡º Vanuatu',
                  'ðŸ‡»ðŸ‡ª Venezuela',
                  'ðŸ‡»ðŸ‡³ Vietnam',
                  'ðŸ‡¾ðŸ‡ª Yemen',
                  'ðŸ‡¿ðŸ‡² Zambia',
                  'ðŸ‡¿ðŸ‡¼ Zimbabwe',
                ]
                    .map<DropdownMenuItem<String>>(
                      (String value) => DropdownMenuItem<String>(
                        value: value,
                        child: Text(value),
                      ),
                    )
                    .toList(),
                onChanged: (String? newValue) {
                  setState(() {
                    _selectedLocation = newValue ?? '';
                  });
                },
              ),
            ),
            SizedBox(height: 16),
            Padding(
              padding: const EdgeInsets.symmetric(horizontal: 30),
              child: TextField(
                controller: detailsController,
                maxLines: 5,
                decoration: InputDecoration(
                  filled: true,
                  fillColor: Colors.transparent, // Set the text field color
                  hintText: ' bio',
                  hintStyle: TextStyle(color: Colors.black),
                ),
              ),
            ),
            SizedBox(height: 16),
            Padding(
              padding: const EdgeInsets.symmetric(horizontal: 30),
              child: Center(
                child: ElevatedButton(
                  onPressed: () {
                    showDialog(
                      context: context,
                      builder: (_) => AlertDialog(
                        title: const Text('Confirmation'),
                        content: const Text(
                            'Are you sure you want to finish your profile?'),
                        actions: [
                          TextButton(
                            onPressed: () {
                              Navigator.of(context)
                                  .pop(); // Close the confirmation dialog
                              sendUpdateRequest(); // Send the update request
                            },
                            child: const Text('Yes'),
                          ),
                          TextButton(
                            onPressed: () {
                              Navigator.of(context)
                                  .pop(); // Close the confirmation dialog
                            },
                            child: const Text('No'),
                          ),
                        ],
                      ),
                    );
                  },
                  style: ElevatedButton.styleFrom(
                    primary: Color(0xFF284855), // Set the button color
                  ),
                  child: const Text('Finish'),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }
}

class DropdownDialog extends StatelessWidget {
  final String value;
  final List<String> items;
  final ValueChanged<String?> onChanged;

  const DropdownDialog({
    required this.value,
    required this.items,
    required this.onChanged,
  });

  @override
  Widget build(BuildContext context) {
    return Dialog(
      child: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          SizedBox(
            width: double.infinity,
            child: ListView.builder(
              shrinkWrap: true,
              itemCount: items.length,
              itemBuilder: (context, index) {
                final item = items[index];
                return ListTile(
                  title: Text(item),
                  onTap: () {
                    onChanged(item);
                  },
                );
              },
            ),
          ),
        ],
      ),
    );
  }
}

